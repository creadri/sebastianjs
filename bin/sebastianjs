#!/usr/bin/env node
// Tiny CLI for SebastianJS: render Mermaid to SVG
// Usage:
//   sebastianjs [input.mmd|-] [-o output.svg]

import { readFile, writeFile } from 'node:fs/promises';
import { stdin as input } from 'node:process';
import { render } from '../src/index.js';

function parseArgs(argv) {
  const args = { input: null, output: null, theme: null, themeCSS: null, themeVariables: null, normalizeViewBox: true, viewBoxMargin: 4, width: null, height: null, autoSize: false, maxWidth: null, maxHeight: null };
  const rest = [];
  for (let i = 0; i < argv.length; i++) {
    const a = argv[i];
    if (a === '-o' || a === '--output') {
      args.output = argv[++i];
    } else if (a === '-t' || a === '--theme') {
      args.theme = argv[++i];
    } else if (a === '--theme-css') {
      args.themeCSS = argv[++i];
    } else if (a === '--theme-vars' || a === '--theme-variables') {
      const v = argv[++i];
      try { args.themeVariables = JSON.parse(v); } catch { args.themeVariables = null; }
    } else if (a === '--normalize-viewbox') {
      args.normalizeViewBox = true;
    } else if (a === '--viewbox-margin') {
      args.viewBoxMargin = Number(argv[++i]);
    } else if (a === '-W' || a === '--width') {
      args.width = Number(argv[++i]);
    } else if (a === '-H' || a === '--height') {
      args.height = Number(argv[++i]);
    } else if (a === '--auto-size') {
      args.autoSize = true;
    } else if (a === '--max-width') {
      args.maxWidth = Number(argv[++i]);
    } else if (a === '--max-height') {
      args.maxHeight = Number(argv[++i]);
    } else if (a === '-h' || a === '--help') {
      args.help = true;
    } else {
      rest.push(a);
    }
  }
  if (rest.length > 0) args.input = rest[0];
  return args;
}

async function readStdin() {
  const chunks = [];
  for await (const chunk of input) chunks.push(chunk);
  return Buffer.concat(chunks).toString('utf8');
}

async function main() {
  const args = parseArgs(process.argv.slice(2));
  if (args.help) {
  console.error('Usage: sebastianjs [input.mmd|-] [-o output.svg] [-t theme] [--theme-css css] [--theme-vars json] [--normalize-viewbox] [--viewbox-margin N] [-W width] [-H height] [--auto-size] [--max-width N] [--max-height N]');
    process.exit(0);
  }

  let def;
  try {
    if (args.input && args.input !== '-') {
      def = await readFile(args.input, 'utf8');
    } else {
      def = await readStdin();
    }
    if (!def || !def.trim()) {
      console.error('No Mermaid definition provided.');
      process.exit(2);
    }
  } catch (err) {
    console.error('Failed to read input:', err.message || err);
    process.exit(1);
  }

  try {
    const svg = await render(def, {
      theme: args.theme || undefined,
      themeCSS: args.themeCSS || undefined,
      themeVariables: args.themeVariables || undefined,
      normalizeViewBox: args.normalizeViewBox,
      viewBoxMargin: args.viewBoxMargin,
      width: args.width || undefined,
      height: args.height || undefined,
  autoSize: args.autoSize,
  maxWidth: args.maxWidth || undefined,
  maxHeight: args.maxHeight || undefined,
    });
    if (args.output) {
      await writeFile(args.output, svg, 'utf8');
    } else {
      process.stdout.write(svg);
    }
  } catch (err) {
    console.error('Render failed:', err?.stack || err?.message || String(err));
    process.exit(1);
  }
}

main();
